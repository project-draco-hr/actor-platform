{
  query=query.trim().toLowerCase();
  ArrayList<MentionFilterResult> results=new ArrayList<MentionFilterResult>();
  final Group group=groups().getValue(gid);
  GroupMember[] members=group.getMembers().toArray(new GroupMember[group.getMembers().size()]);
  Arrays.sort(members,new Comparator<GroupMember>(){
    @Override public int compare(    GroupMember a,    GroupMember b){
      User ua=users().getValue(a.getUid());
      User ub=users().getValue(b.getUid());
      return ua.getName().compareToIgnoreCase(ub.getName());
    }
  }
);
  for (  GroupMember member : members) {
    if (member.getUid() == myUid()) {
      continue;
    }
    User user=users().getValue(member.getUid());
    boolean isNick=user.getNick() != null;
    String mention;
    String secondName;
    if (isNick) {
      mention=user.getNick();
      secondName=user.getName();
    }
 else {
      if (user.getLocalName() != null) {
        mention=user.getServerName();
        secondName=user.getLocalName();
      }
 else {
        mention=user.getName();
        secondName=null;
      }
    }
    if (query.length() == 0) {
      results.add(new MentionFilterResult(user.getUid(),user.getAvatar(),isNick ? "@" + mention : mention,new ArrayList<StringMatch>(),secondName,new ArrayList<StringMatch>(),isNick));
    }
 else {
      List<StringMatch> mentionMatches=StringMatcher.findMatches(mention,query);
      if (secondName != null) {
        List<StringMatch> secondNameMatches=StringMatcher.findMatches(secondName,query);
        if (mentionMatches.size() > 0 || secondNameMatches.size() > 0) {
          if (isNick) {
            List<StringMatch> nickMatches=new ArrayList<StringMatch>();
            for (            StringMatch m : mentionMatches) {
              nickMatches.add(new StringMatch(m.getStart() + 1,m.getLength()));
            }
            mentionMatches=nickMatches;
          }
          results.add(new MentionFilterResult(user.getUid(),user.getAvatar(),isNick ? "@" + mention : mention,mentionMatches,secondName,secondNameMatches,isNick));
        }
      }
 else {
        if (mentionMatches.size() > 0) {
          results.add(new MentionFilterResult(user.getUid(),user.getAvatar(),mention,mentionMatches,null,null,false));
        }
      }
    }
  }
  if (results.size() > SEARCH_LIMIT) {
    results.clear();
  }
  return results;
}
