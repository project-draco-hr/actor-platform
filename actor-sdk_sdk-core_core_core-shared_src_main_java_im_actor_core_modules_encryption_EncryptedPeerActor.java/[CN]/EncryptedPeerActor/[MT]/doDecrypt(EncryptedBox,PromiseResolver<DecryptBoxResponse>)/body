{
  final int senderKeyGroup=ByteStrings.bytesToInt(ByteStrings.substring(data.getEncryptedPackage(),0,4));
  final byte[] encPackage=ByteStrings.substring(data.getEncryptedPackage(),4,data.getEncryptedPackage().length - 4);
  PromisesArray.of(data.getKeys()).filter(new Predicate<EncryptedBoxKey>(){
    @Override public boolean apply(    EncryptedBoxKey boxKey){
      return boxKey.getUid() == myUid() && boxKey.getKeyGroupId() == ownKeyGroupId && "curve25519".equals(boxKey.getKeyAlg());
    }
  }
).first().mapPromise(new Function<EncryptedBoxKey,Promise<SessionActor>>(){
    @Override public Promise<SessionActor> apply(    EncryptedBoxKey boxKey){
      final long senderEphermalKey0Id=ByteStrings.bytesToLong(boxKey.getEncryptedKey(),4);
      final long receiverEphermalKey0Id=ByteStrings.bytesToLong(boxKey.getEncryptedKey(),12);
      if (activeSessions.containsKey(boxKey.getKeyGroupId())) {
        for (        SessionActor s : activeSessions.get(boxKey.getKeyGroupId()).getSessions()) {
          if (s.getOwnKeyId() == receiverEphermalKey0Id && s.getTheirKeyId() == senderEphermalKey0Id) {
            return success(s);
          }
        }
      }
      return context().getEncryption().getSessionManagerInt().pickSession(uid,boxKey.getKeyGroupId(),receiverEphermalKey0Id,senderEphermalKey0Id).map(new Function<PeerSession,SessionActor>(){
        @Override public SessionActor apply(        PeerSession src){
          return spawnSession(src.getTheirKeyGroupId(),src.getTheirPreKeyId(),src.getOwnPreKeyId());
        }
      }
);
    }
  }
).mapPromise(new Function<SessionActor,Promise<EncryptedSessionActor.DecryptedPackage>>(){
    @Override public Promise<EncryptedSessionActor.DecryptedPackage> apply(    SessionActor src){
      return ask(src.getActorRef(),new EncryptedSessionActor.DecryptPackage(data.getEncryptedPackage()));
    }
  }
).map(new Function<EncryptedSessionActor.DecryptedPackage,byte[]>(){
    @Override public byte[] apply(    EncryptedSessionActor.DecryptedPackage decryptedPackage){
      byte[] encData;
      try {
        encData=ActorBox.openBox(ByteStrings.intToBytes(senderKeyGroup),encPackage,new ActorBoxKey(decryptedPackage.getData()));
        ApiMessage message=ApiMessage.fromBytes(encData);
        Log.d(TAG,"Box open:" + message);
      }
 catch (      IOException e) {
        e.printStackTrace();
      }
      return null;
    }
  }
).failure(new Consumer<Exception>(){
    @Override public void apply(    Exception e){
      resolver.error(e);
    }
  }
).done(self());
}
