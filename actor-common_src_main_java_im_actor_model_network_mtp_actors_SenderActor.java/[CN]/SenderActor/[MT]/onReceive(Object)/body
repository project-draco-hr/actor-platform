{
  if (message instanceof SendMessage) {
    Log.d(TAG,"Received SendMessage #" + ((SendMessage)message).mid);
    SendMessage sendMessage=(SendMessage)message;
    ProtoMessage holder=new ProtoMessage(sendMessage.mid,sendMessage.message);
    unsentPackages.put(holder.getMessageId(),holder);
    doSend(holder);
  }
 else   if (message instanceof ConnectionCreated) {
    Log.d(TAG,"Received ConnectionCreated");
    ArrayList<ProtoMessage> toSend=new ArrayList<ProtoMessage>();
    for (    ProtoMessage unsentPackage : unsentPackages.values()) {
      Log.d(TAG,"ReSending #" + unsentPackage.getMessageId());
      toSend.add(unsentPackage);
    }
    doSend(toSend);
  }
 else   if (message instanceof ForgetMessage) {
    Log.d(TAG,"Received ForgetMessage #" + ((ForgetMessage)message).mid);
    unsentPackages.remove(((ForgetMessage)message).mid);
  }
 else   if (message instanceof ConfirmMessage) {
    Log.d(TAG,"Confirming message #" + ((ConfirmMessage)message).mid);
    confirm.add(((ConfirmMessage)message).mid);
    if (confirm.size() >= ACK_THRESHOLD) {
      self().sendOnce(new ForceAck());
    }
 else     if (confirm.size() == 1) {
      self().sendOnce(new ForceAck(),ACK_DELAY);
    }
  }
 else   if (message instanceof ForceAck) {
    if (confirm.size() == 0) {
      return;
    }
    String acks="";
    for (    Long l : confirm) {
      if (acks.length() != 0) {
        acks+=",";
      }
      acks+="#" + l;
    }
    Log.d(TAG,"Sending acks " + acks);
    MessageAck messageAck=buildAck();
    confirm.clear();
    doSend(new ProtoMessage(MTUids.nextId(),messageAck.toByteArray()));
  }
 else   if (message instanceof NewSession) {
    Log.d(TAG,"Received NewSessionCreated");
    ArrayList<ProtoMessage> toSend=new ArrayList<ProtoMessage>();
    for (    ProtoMessage unsentPackage : unsentPackages.values()) {
      Log.d(TAG,"ReSending #" + unsentPackage.getMessageId());
      toSend.add(unsentPackage);
    }
    doSend(toSend);
  }
}
