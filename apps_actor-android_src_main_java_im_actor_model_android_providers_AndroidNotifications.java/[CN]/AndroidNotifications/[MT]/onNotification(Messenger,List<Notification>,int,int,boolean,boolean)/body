{
  final NotificationCompat.Builder builder=new NotificationCompat.Builder(context);
  builder.setAutoCancel(true);
  builder.setSmallIcon(R.drawable.ic_app_notify);
  builder.setPriority(NotificationCompat.PRIORITY_HIGH);
  builder.setCategory(NotificationCompat.CATEGORY_MESSAGE);
  int defaults=NotificationCompat.DEFAULT_LIGHTS;
  if (messenger().isNotificationSoundEnabled()) {
    defaults|=NotificationCompat.DEFAULT_SOUND;
  }
  if (messenger().isNotificationVibrationEnabled()) {
    defaults|=NotificationCompat.DEFAULT_VIBRATE;
  }
  if (silentUpdate) {
    defaults=0;
  }
  builder.setDefaults(defaults);
  final Notification topNotification=topNotifications.get(0);
  if (!silentUpdate) {
    builder.setTicker(getNotificationTextFull(topNotification));
  }
  final AvatarView avatar=new AvatarView(context);
  avatar.init(Screen.dp(42),12);
  if (messagesCount == 1) {
    final String sender=getNotificationSender(topNotification);
    final CharSequence text=getNotificationText(topNotification);
    visiblePeer=topNotification.getPeer();
    avatar.bind(visiblePeer,new NotifaicationCallback(){
      @Override public void onAvatarLoaded(){
        android.app.Notification result=builder.setContentTitle(sender).setContentText(text).setLargeIcon(drawableToBitmap(avatar.getDrawable())).setContentIntent(PendingIntent.getActivity(context,0,Intents.openDialog(topNotification.getPeer(),false,context),PendingIntent.FLAG_UPDATE_CURRENT)).setStyle(new NotificationCompat.BigTextStyle().bigText(text)).build();
        NotificationManager manager=(NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);
        manager.notify(NOTIFICATION_ID,result);
      }
    }
);
  }
 else   if (conversationsCount == 1) {
    String sender=getNotificationSender(topNotification);
    builder.setContentTitle(sender);
    builder.setContentText(messagesCount + " messages");
    visiblePeer=topNotification.getPeer();
    builder.setContentIntent(PendingIntent.getActivity(context,0,Intents.openDialog(topNotification.getPeer(),false,context),PendingIntent.FLAG_UPDATE_CURRENT));
    final NotificationCompat.InboxStyle inboxStyle=new NotificationCompat.InboxStyle();
    for (    Notification n : topNotifications) {
      if (topNotification.getPeer().getPeerType() == PeerType.GROUP) {
        inboxStyle.addLine(getNotificationTextFull(n));
      }
 else {
        inboxStyle.addLine(getNotificationText(n));
      }
    }
    inboxStyle.setSummaryText(messagesCount + " messages");
    avatar.bind(visiblePeer,new NotifaicationCallback(){
      @Override public void onAvatarLoaded(){
        android.app.Notification result=builder.setLargeIcon(drawableToBitmap(avatar.getDrawable())).setStyle(inboxStyle).build();
        NotificationManager manager=(NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);
        manager.notify(NOTIFICATION_ID,result);
      }
    }
);
  }
 else {
    builder.setContentTitle(context.getString(R.string.app_name));
    builder.setContentText(messagesCount + " messages in " + conversationsCount+ " chats");
    visiblePeer=null;
    builder.setContentIntent(PendingIntent.getActivity(context,0,new Intent(context,MainActivity.class),PendingIntent.FLAG_UPDATE_CURRENT));
    NotificationCompat.InboxStyle inboxStyle=new NotificationCompat.InboxStyle();
    for (    Notification n : topNotifications) {
      inboxStyle.addLine(getNotificationTextFull(n));
    }
    inboxStyle.setSummaryText(messagesCount + " messages in " + conversationsCount+ " chats");
    android.app.Notification result=builder.setStyle(inboxStyle).build();
    NotificationManager manager=(NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);
    manager.notify(NOTIFICATION_ID,result);
  }
}
