{
  FetchResult result;
  long oldKey;
synchronized (envelopes) {
    oldKey=topKey;
    if (envelopes.isEmpty()) {
      return null;
    }
    ScheduledEnvelope envelope=envelopes.firstEntry().getValue();
    if (envelope.getTime() <= time) {
      envelopes.remove(envelope.getKey());
      if (envelopes.isEmpty()) {
        topKey=0;
      }
 else {
        topKey=envelopes.firstKey();
      }
      result=FetchResult.envelope(envelope);
    }
 else {
      result=FetchResult.delay(envelope.getTime() - time);
    }
  }
  if (oldKey != topKey) {
    root.changedTopKey(this);
  }
  return result;
}
