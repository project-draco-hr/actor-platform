{
  BitmapFactory.Options o=new BitmapFactory.Options();
  o.inJustDecodeBounds=true;
  o.inTempStorage=WorkCache.BITMAP_TMP.get();
  BitmapFactory.decodeFile(fileName,o);
  if (o.outWidth == 0 || o.outHeight == 0) {
    throw new ImageLoadException("BitmapFactory.decodeFile: unable to load file");
  }
  int w=o.outWidth;
  int h=o.outHeight;
  ExifInterface exif=null;
  int orientationTag=0;
  try {
    exif=new ExifInterface(fileName);
    String exifOrientation=exif.getAttribute(ExifInterface.TAG_ORIENTATION);
    if (exifOrientation != null) {
      if (exifOrientation.equals("5") || exifOrientation.equals("6") || exifOrientation.equals("7")|| exifOrientation.equals("8")) {
        w=o.outHeight;
        h=o.outWidth;
      }
      orientationTag=Integer.parseInt(exifOrientation);
    }
  }
 catch (  IOException e) {
  }
  ImageFormat format=ImageFormat.UNKNOWN;
  if ("image/jpeg".equals(o.outMimeType) || "image/jpg".equals(o.outMimeType)) {
    format=ImageFormat.JPEG;
  }
 else   if ("image/gif".equals(o.outMimeType)) {
    format=ImageFormat.GIF;
  }
 else   if ("image/bmp".equals(o.outMimeType)) {
    format=ImageFormat.BMP;
  }
 else   if ("image/webp".equals(o.outMimeType)) {
    format=ImageFormat.WEBP;
  }
  return new ImageMetadata(w,h,orientationTag,format);
}
