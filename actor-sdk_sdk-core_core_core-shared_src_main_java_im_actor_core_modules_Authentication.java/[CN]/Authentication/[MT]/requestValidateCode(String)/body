{
  if (code == null) {
    throw new RuntimeException("Code couldn't be null!");
  }
  return new Command<AuthState>(){
    @Override public void start(    final CommandCallback<AuthState> callback){
      String transactionHash=modules.getPreferences().getString(KEY_TRANSACTION_HASH);
      request(new RequestValidateCode(transactionHash,code),new RpcCallback<ResponseAuth>(){
        @Override public void onResult(        ResponseAuth response){
          onLoggedIn(callback,response);
        }
        @Override public void onError(        final RpcException e){
          if ("PHONE_CODE_EXPIRED".equals(e.getTag()) || "EMAIL_CODE_EXPIRED".equals(e.getTag())) {
            resetAuth();
          }
 else           if ("PHONE_NUMBER_UNOCCUPIED".equals(e.getTag()) || "EMAIL_UNOCCUPIED".equals(e.getTag())) {
            modules.getPreferences().putString(KEY_CODE,code);
            state=AuthState.SIGN_UP;
            Runtime.postToMainThread(new Runnable(){
              @Override public void run(){
                callback.onResult(AuthState.SIGN_UP);
              }
            }
);
            return;
          }
          Runtime.postToMainThread(new Runnable(){
            @Override public void run(){
              callback.onError(e);
            }
          }
);
        }
      }
);
    }
  }
;
}
