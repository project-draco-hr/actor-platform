{
  if (isInProgress) {
    isInvalidated=true;
    return;
  }
  isInProgress=true;
  isInvalidated=false;
  Long[] uids=contactUsers.toArray(new Long[0]);
  Arrays.sort(uids);
  String hash="";
  for (  long u : uids) {
    if (hash.length() != 0) {
      hash+=",";
    }
    hash+=u;
  }
  String hashValue=Crypto.hex(Crypto.SHA256(hash.getBytes()));
  Logger.d(TAG,"Performing sync with uids: " + hash);
  Logger.d(TAG,"Performing sync with hash: " + hashValue);
  ask(requests().getContacts(hashValue),new FutureCallback<ResponseGetContacts>(){
    @Override public void onResult(    final ResponseGetContacts result){
      isInProgress=false;
      if (result.isNotChanged()) {
        Logger.d(TAG,"Sync: Not changed");
        if (isInvalidated) {
          performSync();
        }
 else {
          ProfileSyncState.onContactsLoaded(contactUsers.size() == 0);
        }
        return;
      }
      Logger.d(TAG,"Sync: Users count: " + result.getUsers().size());
      final boolean isInvalidatedFinal=isInvalidated;
      ask(userActor().onUpdateUsers(result.getUsers()),new FutureCallback<Boolean>(){
        @Override public void onResult(        Boolean result2){
          outer:           for (          long user : contactUsers.toArray(new Long[0])) {
            for (            User u : result.getUsers()) {
              if (user == u.getId()) {
                continue outer;
              }
            }
            UserModel userModel=users().get((int)user);
            userModel.getContactModel().change(false);
            contactUsers.remove(user);
          }
          outer:           for (          User u : result.getUsers()) {
            for (            long user : contactUsers.toArray(new Long[0])) {
              if (user == u.getId()) {
                continue outer;
              }
            }
            UserModel userModel=users().get(u.getId());
            userModel.getContactModel().change(true);
            contactUsers.add((long)u.getId());
          }
          updateContactList();
          if (!isInvalidatedFinal) {
            ProfileSyncState.onContactsLoaded(contactUsers.size() == 0);
          }
        }
        @Override public void onError(        Throwable throwable){
          throwable.printStackTrace();
        }
      }
);
      if (isInvalidated) {
        performSync();
      }
    }
    @Override public void onError(    Throwable throwable){
      isInProgress=false;
      throwable.printStackTrace();
    }
  }
);
}
