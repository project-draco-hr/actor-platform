{
  if (date <= loadLastReadState(peer)) {
    return;
  }
  boolean isPeerEnabled=context().getSettingsModule().isNotificationsEnabled(peer);
  boolean isEnabled=context().getSettingsModule().isNotificationsEnabled() && isPeerEnabled;
  boolean isInAppEnabled=context().getSettingsModule().isInAppEnabled();
  boolean isConversationTonesEnabled=context().getSettingsModule().isConversationTonesEnabled();
  if (peer.getPeerType() == PeerType.GROUP) {
    if (!context().getSettingsModule().isGroupNotificationsEnabled()) {
      isEnabled=false;
    }
 else {
      if (context().getSettingsModule().isGroupNotificationsOnlyMentionsEnabled()) {
        isEnabled=hasCurrentUserMention;
      }
    }
  }
  if (!isEnabled && (!(isInAppEnabled && peer.equals(visiblePeer)))) {
    return;
  }
  List<PendingNotification> allPending=getNotifications();
  allPending.add(new PendingNotification(peer,sender,date,description));
  saveStorage();
  if (isNotificationsPaused) {
    notificationsDuringPause.add(peer);
    return;
  }
  if (config().getNotificationProvider() != null) {
    if (isAppVisible) {
      if (visiblePeer != null && visiblePeer.equals(peer)) {
        if (isConversationTonesEnabled) {
          config().getNotificationProvider().onMessageArriveInApp(context().getMessenger());
        }
      }
 else       if (isDialogsVisible) {
        if (isConversationTonesEnabled) {
          config().getNotificationProvider().onMessageArriveInApp(context().getMessenger());
        }
      }
 else       if (isInAppEnabled) {
        performNotification(false);
      }
    }
 else {
      performNotification(false);
    }
  }
}
