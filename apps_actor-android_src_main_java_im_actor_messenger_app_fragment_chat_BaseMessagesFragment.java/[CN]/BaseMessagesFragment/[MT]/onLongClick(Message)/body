{
  if (actionMode == null) {
    messagesAdapter.clearSelection();
    messagesAdapter.setSelected(message,true);
    actionMode=((AppCompatActivity)getActivity()).startSupportActionMode(new ActionMode.Callback(){
      @Override public boolean onCreateActionMode(      ActionMode actionMode,      Menu menu){
        getActivity().getMenuInflater().inflate(R.menu.messages_context,menu);
        return true;
      }
      @Override public boolean onPrepareActionMode(      ActionMode actionMode,      Menu menu){
        Message[] selected=messagesAdapter.getSelected();
        if (selected.length > 0) {
          actionMode.setTitle("" + selected.length);
        }
        boolean isAllText=true;
        for (        Message k : selected) {
          if (!(k.getContent() instanceof TextContent)) {
            isAllText=false;
            break;
          }
        }
        menu.findItem(R.id.copy).setVisible(isAllText);
        return false;
      }
      @Override public boolean onActionItemClicked(      final ActionMode actionMode,      MenuItem menuItem){
        if (menuItem.getItemId() == R.id.delete) {
          Message[] selected=messagesAdapter.getSelected();
          final long[] rids=new long[selected.length];
          for (int i=0; i < rids.length; i++) {
            rids[i]=selected[i].getRid();
          }
          new AlertDialog.Builder(getActivity()).setMessage(getString(R.string.alert_delete_messages_text).replace("{0}","" + rids.length)).setPositiveButton(R.string.alert_delete_messages_yes,new DialogInterface.OnClickListener(){
            @Override public void onClick(            DialogInterface dialog,            int which){
              messenger().deleteMessages(peer,rids);
              actionMode.finish();
            }
          }
).setNegativeButton(R.string.dialog_cancel,null).show().setCanceledOnTouchOutside(true);
          return true;
        }
 else         if (menuItem.getItemId() == R.id.copy) {
          String text=messenger().getFormatter().formatMessages(messagesAdapter.getSelected());
          android.content.ClipboardManager clipboard=(android.content.ClipboardManager)getActivity().getSystemService(Context.CLIPBOARD_SERVICE);
          android.content.ClipData clip=android.content.ClipData.newPlainText("Messages",text);
          clipboard.setPrimaryClip(clip);
          Toast.makeText(getActivity(),R.string.toast_messages_copied,Toast.LENGTH_SHORT).show();
          actionMode.finish();
          return true;
        }
        return false;
      }
      @Override public void onDestroyActionMode(      ActionMode actionMode){
        BaseMessagesFragment.this.actionMode=null;
        messagesAdapter.clearSelection();
      }
    }
);
  }
 else {
    if (messagesAdapter.isSelected(message)) {
      messagesAdapter.setSelected(message,false);
      if (messagesAdapter.getSelectedCount() == 0) {
        actionMode.finish();
        actionMode=null;
      }
 else {
        actionMode.invalidate();
      }
    }
 else {
      messagesAdapter.setSelected(message,true);
      actionMode.invalidate();
    }
  }
  return true;
}
