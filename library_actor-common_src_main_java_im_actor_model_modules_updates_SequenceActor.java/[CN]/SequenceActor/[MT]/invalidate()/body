{
  if (!isValidated) {
    return;
  }
  isValidated=false;
  if (seq < 0) {
    Log.d(TAG,"Loading fresh state...");
    request(new RequestGetState(),new RpcCallback<ResponseSeq>(){
      @Override public void onResult(      ResponseSeq response){
        if (isValidated) {
          return;
        }
        seq=response.getSeq();
        state=response.getState();
        isValidated=true;
        preferences().putInt(KEY_SEQ,seq);
        preferences().putBytes(KEY_STATE,state);
        Log.d(TAG,"State loaded {seq=" + seq + "}");
        checkRunnables();
        checkFuture();
        isTimerStarted=false;
        self().sendOnce(new ForceInvalidate(),24 * 60 * 60* 1000L);
      }
      @Override public void onError(      RpcException e){
        if (isValidated) {
          return;
        }
        isValidated=true;
        invalidate();
      }
    }
);
  }
 else {
    Log.d(TAG,"Loading difference...");
    request(new RequestGetDifference(seq,state),new RpcCallback<ResponseGetDifference>(){
      @Override public void onResult(      ResponseGetDifference response){
        if (isValidated) {
          return;
        }
        Log.d(TAG,"Difference loaded {seq=" + response.getSeq() + "}");
        ArrayList<Update> updates=new ArrayList<Update>();
        for (        DifferenceUpdate u : response.getUpdates()) {
          try {
            updates.add(parser.read(u.getUpdateHeader(),u.getUpdate()));
          }
 catch (          IOException e) {
            e.printStackTrace();
            Log.d(TAG,"Broken update #" + u.getUpdateHeader() + ": ignoring");
          }
        }
        processor.applyDifferenceUpdate(response.getUsers(),response.getGroups(),updates);
        seq=response.getSeq();
        state=response.getState();
        isValidated=true;
        preferences().putInt(KEY_SEQ,seq);
        preferences().putBytes(KEY_STATE,state);
        checkRunnables();
        checkFuture();
        isTimerStarted=false;
        self().sendOnce(new ForceInvalidate(),24 * 60 * 60* 1000L);
        if (response.needMore()) {
          invalidate();
        }
      }
      @Override public void onError(      RpcException e){
        if (isValidated) {
          return;
        }
        isValidated=true;
        invalidate();
      }
    }
);
  }
}
