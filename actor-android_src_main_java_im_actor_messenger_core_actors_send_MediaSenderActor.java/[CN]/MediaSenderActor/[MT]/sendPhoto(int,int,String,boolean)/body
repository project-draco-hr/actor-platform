{
  try {
    ImageMetadata metadata=new FileSource(fileName).getImageMetadata();
    Bitmap preloaded=ImageLoading.loadBitmapOptimizedHQ(fileName);
    final Bitmap optimized=ImageRotating.fixExif(preloaded,metadata.getExifOrientation());
    final Bitmap smallThumb=ImageScaling.scaleFit(optimized,90,90);
    final byte[] data=ImageLoading.saveJpeg(smallThumb,ImageLoading.JPEG_QUALITY_LOW);
    final String resultFileName=AppContext.getExternalTempFile("image","jpg");
    if (resultFileName == null) {
      return;
    }
    ImageLoading.save(optimized,resultFileName);
    final FastThumb thumb=new FastThumb(smallThumb.getWidth(),smallThumb.getHeight(),data);
    byte[] thumbData=thumb.toByteArray();
    PhotoMessage photoMessage=new PhotoMessage(resultFileName,optimized.getWidth(),optimized.getHeight(),thumb,isEncrypted);
    byte[] extension;
    int extType;
    if (isEncrypted) {
      extension=EncryptedMessages.photoMetadata(optimized.getWidth(),optimized.getHeight());
      extType=0x01;
    }
 else {
      extension=new FileExPhoto(optimized.getWidth(),optimized.getHeight()).toByteArray();
      extType=0x01;
    }
    sendFile(type,id,"image.jpg",thumbData,photoMessage,extType,extension,isEncrypted);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
}
