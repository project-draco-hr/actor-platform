{
  if (message instanceof AuthReset) {
    processState.changeState(STATE_START);
    authStorage.logOut();
  }
 else   if (message instanceof AuthRequestCode) {
    AuthRequestCode requestCode=(AuthRequestCode)message;
    if (!processState.changeState(STATE_REQUESTING_SMS)) {
      return;
    }
    sendRequestAuthCode(requestCode.getPhone());
  }
 else   if (message instanceof AuthSendCode) {
    final AuthSendCode code=(AuthSendCode)message;
    if (!processState.changeState(STATE_CODE_SENDING)) {
      return;
    }
    KeyPair savedKeyPair=keyStorage().getKeyPair();
    if (savedKeyPair == null) {
      keyStorage().setKey(im.actor.crypto.KeyTools.generateNewRsaKey());
    }
    sendCode(code.getCode());
  }
 else   if (message instanceof ResetCodeSend) {
    processState.changeState(STATE_REQUESTED_SMS);
  }
 else   if (message instanceof TryAgainCodeSend) {
    if (processState.getSmsCode() != 0) {
      if (processState.changeState(STATE_CODE_SENDING)) {
        sendCode(processState.getSmsCode());
      }
    }
 else {
      processState.changeState(STATE_START);
    }
  }
 else   if (message instanceof ResetCodeRequest) {
    processState.changeState(STATE_START);
  }
 else   if (message instanceof TryAgainCodeRequest) {
    if (processState.getPhoneNumber() != 0) {
      if (processState.changeState(STATE_REQUESTING_SMS)) {
        sendRequestAuthCode(processState.getPhoneNumber());
      }
    }
 else {
      processState.changeState(STATE_START);
    }
  }
 else   if (message instanceof PerformSignup) {
    if (processState.changeState(STATE_SIGNING)) {
      if (processState.getPhoneNumber() != 0 && processState.getSmsCode() != 0 && processState.getSmsHash() != null) {
        sendSignup(((PerformSignup)message).getName(),((PerformSignup)message).avatarPath);
      }
 else {
        processState.changeState(STATE_START);
      }
    }
  }
 else   if (message instanceof TryAgainSignup) {
    if (processState.getPhoneNumber() != 0 && processState.getSmsCode() != 0 && processState.getSmsHash() != null && processState.getName() != null) {
      sendSignup(processState.getName(),processState.getAvatarImage());
    }
 else {
      processState.changeState(STATE_START);
    }
  }
 else   if (message instanceof ResetSignup) {
    processState.changeState(STATE_SIGN_UP);
  }
 else {
    drop(message);
  }
}
