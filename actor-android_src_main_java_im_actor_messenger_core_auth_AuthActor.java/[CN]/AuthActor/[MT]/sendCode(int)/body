{
  processState.setSmsCode(code);
  KeyPair keyPair=keyStorage().getKeyPair();
  ask(requests().signIn(processState.getPhoneNumber(),processState.getSmsHash(),"" + code,KeyTools.encodeRsaPublicKey(keyPair.getPublic()),deviceIdHash,deviceName,APP_ID,APP_KEY),new FutureCallback<ResponseAuth>(){
    @Override public void onResult(    ResponseAuth result){
      completeAuth(result.getUser());
    }
    @Override public void onError(    Throwable throwable){
      if (throwable instanceof ApiRequestException) {
        ApiRequestException requestException=(ApiRequestException)throwable;
        if ("PHONE_NUMBER_UNOCCUPIED".equals(requestException.getErrorTag())) {
          processState.changeState(STATE_SIGN_UP);
          return;
        }
        if ("CODE_EXPIRED".equals(requestException.getErrorTag())) {
          processState.changeState(STATE_SIGN_UP);
          return;
        }
      }
      processState.changeStateError(STATE_CODE_SEND_ERROR,throwable);
    }
  }
);
}
