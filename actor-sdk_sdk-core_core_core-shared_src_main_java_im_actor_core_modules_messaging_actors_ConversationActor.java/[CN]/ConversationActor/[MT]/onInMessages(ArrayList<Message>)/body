{
  Message topMessage=null;
  ArrayList<Message> updated=new ArrayList<>();
  ArrayList<Message> updatedDocs=new ArrayList<>();
  for (  Message m : inMessages) {
    if (m.getSenderId() == myUid()) {
      if (m.isOnServer()) {
        if (m.getSortDate() <= state.getOutReadDate()) {
          m=m.changeState(MessageState.READ);
        }
 else         if (m.getSortDate() <= state.getOutReceiveState()) {
          m=m.changeState(MessageState.RECEIVED);
        }
 else {
          m=m.changeState(MessageState.SENT);
        }
      }
    }
    if (m.isOnServer()) {
      if (topMessage == null) {
        topMessage=m;
      }
 else {
        if (topMessage.getSortDate() < m.getSortDate()) {
          topMessage=m;
        }
      }
    }
    updated.add(m);
    if (m.getContent() instanceof DocumentContent) {
      updatedDocs.add(m);
    }
  }
  messages.addOrUpdateItems(updated);
  docs.addOrUpdateItems(updatedDocs);
  for (  Message m : updated) {
    if (m.getSenderId() == myUid()) {
      if (m.isOnServer() && m.getMessageState() != MessageState.READ) {
        outPendingIndex.put(m.getRid(),m.getDate());
      }
    }
 else {
      if (m.getSortDate() > state.getInReadDate()) {
        inPendingIndex.put(m.getRid(),m.getDate());
      }
    }
    if (m.getSortDate() > state.getInMaxMessageDate()) {
      state=state.changeInMaxDate(m.getSortDate());
      conversationState.addOrUpdateItem(state);
    }
  }
  if (isConversationAutoRead()) {
    checkReadState(false);
  }
  if (topMessage != null) {
    if (!isHiddenPeer) {
      dialogsActor.send(new DialogsActor.InMessage(peer,topMessage,inPendingIndex.getCount()));
    }
    if (dialogsGroupedActor != null) {
      dialogsGroupedActor.send(new ActiveDialogsActor.CounterChanged(peer,inPendingIndex.getCount()));
    }
  }
}
