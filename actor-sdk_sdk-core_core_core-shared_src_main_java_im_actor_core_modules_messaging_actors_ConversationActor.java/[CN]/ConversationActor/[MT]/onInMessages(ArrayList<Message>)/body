{
  Message topMessage=null;
  ArrayList<Message> updated=new ArrayList<Message>();
  ArrayList<Message> updatedDocs=new ArrayList<Message>();
  for (  Message m : inMessages) {
    if (m.getSenderId() == myUid()) {
      if (m.isOnServer()) {
        if (m.getSortDate() <= outReadState) {
          m=m.changeState(MessageState.READ);
        }
 else         if (m.getSortDate() <= outReceiveState) {
          m=m.changeState(MessageState.RECEIVED);
        }
 else {
          m=m.changeState(MessageState.SENT);
        }
      }
    }
    if (m.isOnServer()) {
      if (topMessage == null) {
        topMessage=m;
      }
 else {
        if (topMessage.getSortDate() < m.getSortDate()) {
          topMessage=m;
        }
      }
    }
    updated.add(m);
    if (m.getContent() instanceof DocumentContent) {
      updatedDocs.add(m);
    }
  }
  messages.addOrUpdateItems(updated);
  docs.addOrUpdateItems(updatedDocs);
  for (  Message m : updated) {
    if (m.getSenderId() == myUid()) {
      if (m.isOnServer() && m.getMessageState() != MessageState.READ) {
        outPendingIndex.put(m.getRid(),m.getDate());
      }
    }
 else {
      if (m.getSortDate() > inReadStateNew) {
        inReadStateNew=m.getSortDate();
        preferences().putLong(IN_READ_STATE_NEW_PREF,inReadStateNew);
      }
      if (m.getSortDate() > inReadState) {
        inPendingIndex.put(m.getRid(),m.getDate());
      }
    }
  }
  if (isConversationAutoRead()) {
    checkReadState(false);
  }
  if (topMessage != null) {
    if (!isHiddenPeer) {
      dialogsActor.send(new DialogsActor.InMessage(peer,topMessage,inPendingIndex.getCount()));
    }
    if (dialogsGroupedActor != null) {
      dialogsGroupedActor.send(new ActiveDialogsActor.CounterChanged(peer,inPendingIndex.getCount()));
    }
  }
}
