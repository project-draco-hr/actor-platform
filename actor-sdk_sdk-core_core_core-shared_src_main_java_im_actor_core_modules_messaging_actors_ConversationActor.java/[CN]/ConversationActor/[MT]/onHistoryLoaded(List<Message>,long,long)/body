{
  boolean isChanged=false;
  if (state.getOutReceiveDate() < maxReceiveDate) {
    state=state.changeOutReceiveDate(maxReceiveDate);
    isChanged=true;
  }
  if (state.getOutReadDate() < maxReadDate) {
    state=state.changeOutReadDate(maxReadDate);
    isChanged=true;
  }
  if (isChanged) {
    conversationState.addOrUpdateItem(state);
  }
  ArrayList<Message> updated=new ArrayList<>();
  ArrayList<Message> updatedDocs=new ArrayList<>();
  long maxReadMessage=0;
  for (  Message historyMessage : history) {
    if (messages.getValue(historyMessage.getEngineId()) != null) {
      continue;
    }
    updated.add(historyMessage);
    if (historyMessage.getContent() instanceof DocumentContent) {
      updatedDocs.add(historyMessage);
    }
    if (historyMessage.getSenderId() != myUid()) {
      maxReadMessage=Math.max(maxReadMessage,historyMessage.getSortDate());
    }
  }
  if (updated.size() > 0) {
    messages.addOrUpdateItems(updated);
  }
  if (updatedDocs.size() > 0) {
    docs.addOrUpdateItems(updatedDocs);
  }
  state=state.changeInMaxDate(Math.max(state.getInMaxMessageDate(),maxReadMessage));
  conversationState.addOrUpdateItem(state);
  if (isConversationAutoRead()) {
    checkReadState(true);
  }
}
