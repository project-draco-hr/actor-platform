{
  if (message.getSenderId() == myUid()) {
    if (message.isOnServer()) {
      if (message.getSortDate() <= outReadState) {
        message=message.changeState(MessageState.READ);
      }
 else       if (message.getSortDate() <= outReceiveState) {
        message=message.changeState(MessageState.RECEIVED);
      }
 else {
        message=message.changeState(MessageState.SENT);
      }
    }
  }
  messages.addOrUpdateItem(message);
  if (message.getContent() instanceof DocumentContent) {
    docs.addOrUpdateItem(message);
  }
  if (message.isOnServer()) {
    if (message.getSenderId() == myUid()) {
      if (message.isOnServer() && message.getMessageState() != MessageState.READ) {
        outPendingIndex.put(message.getRid(),message.getDate());
      }
    }
 else {
      if (message.getSortDate() > inReadStateNew) {
        inReadStateNew=message.getSortDate();
        preferences().putLong(IN_READ_STATE_NEW_PREF,inReadStateNew);
      }
      if (message.getSortDate() > inReadState) {
        inPendingIndex.put(message.getRid(),message.getDate());
      }
    }
    if (isConversationAutoRead()) {
      checkReadState(false);
    }
    if (!isHiddenPeer) {
      dialogsActor.send(new DialogsActor.InMessage(peer,message,inPendingIndex.getCount()));
    }
    if (dialogsGroupedActor != null) {
      dialogsGroupedActor.send(new ActiveDialogsActor.CounterChanged(peer,inPendingIndex.getCount()));
    }
  }
}
