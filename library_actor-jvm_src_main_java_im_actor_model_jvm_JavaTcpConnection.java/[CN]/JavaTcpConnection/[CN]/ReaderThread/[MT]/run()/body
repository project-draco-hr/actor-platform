{
  try {
    while (!isClosed()) {
      if (socket.isClosed()) {
        throw new IOException("Socket is closed");
      }
      if (!socket.isConnected()) {
        throw new IOException("Socket is not connected");
      }
      byte[] packageHeader=readBytes(9);
      DataInput dataInput=new DataInput(packageHeader);
      int receivedPackageIndex=dataInput.readInt();
      if (receivedPackageIndex != receivedPackets) {
        throw new IOException("Received frame with incorrect index. " + "Expected: " + receivedPackets + ", got: "+ receivedPackageIndex);
      }
      receivedPackets++;
      int header=dataInput.readByte();
      int size=dataInput.readInt();
      byte[] body=readBytes(size + 4);
      dataInput=new DataInput(body);
      byte[] contents=dataInput.readBytes(size);
      long crc32=dataInput.readUInt();
      crc32Engine.reset();
      crc32Engine.update(contents);
      long localCrc32=crc32Engine.getValue();
      if (localCrc32 != crc32) {
        throw new IOException("Received frame contents with incorrect crc32");
      }
      if (header == HEADER_PROTO) {
        callback.onMessage(contents,0,contents.length);
        DataOutput ackPackage=new DataOutput();
        ackPackage.writeInt(receivedPackageIndex);
        post(HEADER_ACK,ackPackage.toByteArray());
      }
 else       if (header == HEADER_PING) {
        post(HEADER_PONG,contents);
      }
 else       if (header == HEADER_PONG) {
        DataInput pongInput=new DataInput(contents);
        int pongLen=pongInput.readInt();
        if (pongLen != 8) {
          continue;
        }
        onServerPong(pongInput.readLong());
      }
 else       if (header == HEADER_ACK) {
        DataInput ackContent=new DataInput(contents);
        int frameId=ackContent.readInt();
        onServerAck(frameId);
      }
 else       if (header == HEADER_REDIRECT) {
        DataInput redirectContent=new DataInput(contents);
        int hostLen=redirectContent.readInt();
        String host=new String(redirectContent.readBytes(hostLen),"UTF-8");
        int port=redirectContent.readInt();
        int timeout=redirectContent.readInt();
        throw new IOException("Received redirect frame: " + host + ":"+ port+ " with timeout "+ timeout+ " sec");
      }
 else       if (header == HEADER_DROP) {
        DataInput drop=new DataInput(contents);
        long messageId=drop.readLong();
        int errorCode=drop.readByte();
        int messageLen=drop.readInt();
        String message=new String(drop.readBytes(messageLen),"UTF-8");
        throw new IOException("Received drop frame: " + message);
      }
 else {
        Log.w(TAG,"Received unknown frame #" + header);
      }
    }
  }
 catch (  IOException e) {
    e.printStackTrace();
    close();
  }
}
