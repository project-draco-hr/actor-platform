{
  Log.d(TAG,"Received push");
  GoogleCloudMessaging gcm=GoogleCloudMessaging.getInstance(context);
  Bundle extras=intent.getExtras();
  String messageType=gcm.getMessageType(intent);
  if (!extras.isEmpty()) {
    if (GoogleCloudMessaging.MESSAGE_TYPE_MESSAGE.equals(messageType)) {
      if (intent.getExtras().containsKey("mp_message")) {
        String mp_message=intent.getExtras().getString("mp_message");
        NotificationCompat.Builder builder=new NotificationCompat.Builder(context);
        builder.setAutoCancel(true);
        builder.setSmallIcon(R.drawable.ic_app_notify);
        builder.setPriority(NotificationCompat.PRIORITY_HIGH);
        builder.setCategory(NotificationCompat.CATEGORY_MESSAGE);
        int defaults=NotificationCompat.DEFAULT_LIGHTS;
        if (messenger().isNotificationSoundEnabled()) {
          defaults|=NotificationCompat.DEFAULT_SOUND;
        }
        if (messenger().isNotificationVibrationEnabled()) {
          defaults|=NotificationCompat.DEFAULT_VIBRATE;
        }
        builder.setDefaults(defaults);
        builder.setTicker(mp_message);
        builder.setContentTitle(context.getString(R.string.app_name));
        builder.setContentText(mp_message);
        builder.setContentIntent(PendingIntent.getActivity(context,0,new Intent(context,MainActivity.class),PendingIntent.FLAG_UPDATE_CURRENT));
        NotificationManager manager=(NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);
        manager.notify(NOTIFICATION_ID,builder.build());
        setResultCode(Activity.RESULT_OK);
      }
 else {
        if (extras.containsKey("seq")) {
          int seq=Integer.parseInt(extras.getString("seq"));
          Log.d(TAG,"Received seq: " + seq);
          messenger().onPushReceived(seq);
          setResultCode(Activity.RESULT_OK);
        }
 else {
          Log.w(TAG,"Unknown message");
        }
      }
    }
  }
 else {
    Log.w(TAG,"Message with null extras: ignoring");
  }
}
