{
  boolean removed=false;
  ArrayList<OutUnreadMessage> messagesStorageMessages=messagesStorage.getMessages();
  for (  OutUnreadMessage p : messagesStorageMessages.toArray(new OutUnreadMessage[messagesStorageMessages.size()])) {
    if (p.getDate() <= date) {
      Message msg=messages.getValue(p.getRid());
      if (msg != null && (msg.getMessageState() == MessageState.SENT || msg.getMessageState() == MessageState.RECEIVED)) {
        Message updatedMsg=msg.changeState(MessageState.READ);
        messages.addOrUpdateItem(updatedMsg);
        dialogsActor.send(new DialogsActor.MessageStateChanged(peer,p.getRid(),MessageState.READ));
        removed=true;
        messagesStorage.getMessages().remove(p);
      }
    }
  }
  if (removed) {
    savePending();
  }
}
