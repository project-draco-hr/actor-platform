{
  ArrayList<Message> updated=new ArrayList<Message>();
  boolean isPendingChanged=false;
  for (  Message historyMessage : history) {
    if (messages.getValue(historyMessage.getEngineId()) != null) {
      continue;
    }
    updated.add(historyMessage);
    if (historyMessage.getMessageState() == MessageState.SENT) {
      messagesStorage.getMessages().add(new OutUnreadMessage(historyMessage.getRid(),historyMessage.getDate()));
      isPendingChanged=true;
    }
  }
  if (isPendingChanged) {
    savePending();
  }
  if (updated.size() > 0) {
    messages.addOrUpdateItems(updated);
    ArrayList<Message> updatedMedia=new ArrayList<Message>();
    ArrayList<Message> updatedDoc=new ArrayList<Message>();
    for (    Message updatedMsg : updated) {
      if (updatedMsg.getContent() instanceof PhotoContent || updatedMsg.getContent() instanceof VideoContent) {
        updatedMedia.add(updatedMsg);
      }
 else {
        if (updatedMsg.getContent() instanceof DocumentContent) {
        }
      }
    }
    media.addOrUpdateItems(updatedMedia);
  }
}
