{
  intent=getIntent();
  peer=Peer.fromUniqueId(intent.getExtras().getLong(EXTRA_CHAT_PEER));
  checkIsBot();
  if (saveInstance != null) {
    pending_fileName=saveInstance.getString(STATE_FILE_NAME,null);
  }
  super.onCreate(saveInstance);
  onCreateToolbar();
  messageEditText.addTextChangedListener(new TextWatcherImp());
  messageEditText.setOnFocusChangeListener(new View.OnFocusChangeListener(){
    @Override public void onFocusChange(    View v,    boolean hasFocus){
      if (hasFocus) {
        hideShare();
      }
    }
  }
);
  SLIDE_LIMIT=(int)(Screen.getDensity() * 180);
  audioContainer=findViewById(R.id.audioContainer);
  audioTimer=(TextView)findViewById(R.id.audioTimer);
  audioSlide=findViewById(R.id.audioSlide);
  recordPoint=findViewById(R.id.record_point);
  audioButton=(ImageView)findViewById(R.id.record_btn);
  audioButton.setVisibility(View.VISIBLE);
  audioButton.setOnTouchListener(new View.OnTouchListener(){
    @Override public boolean onTouch(    View v,    MotionEvent event){
      if (event.getAction() == MotionEvent.ACTION_DOWN) {
        if (!isAudioVisible) {
          showAudio();
          slideStart=(int)event.getX();
        }
      }
 else       if (event.getAction() == MotionEvent.ACTION_UP) {
        if (isAudioVisible) {
          hideAudio(false);
        }
      }
 else       if (event.getAction() == MotionEvent.ACTION_MOVE) {
        if (isAudioVisible) {
          int slide=slideStart - (int)event.getX();
          if (slide < 0) {
            slide=0;
          }
          if (slide > SLIDE_LIMIT) {
            hideAudio(true);
          }
 else {
            slideAudio(slide);
          }
        }
      }
      return true;
    }
  }
);
  autocompleteList=(RecyclerListView)findViewById(R.id.mentionsList);
  autocompleteList.setBackgroundColor(ActorSDK.sharedActor().style.getMainBackgroundColor());
  quoteContainer=(FrameLayout)findViewById(R.id.quoteContainer);
  quoteContainer.setBackgroundColor(ActorSDK.sharedActor().style.getMainBackgroundColor());
  quoteText=(TextView)findViewById(R.id.quote_text);
  findViewById(R.id.ib_close_quote).setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      goneView(quoteContainer);
      quoteText.setText("");
      currentQuote="";
      if (textEditing) {
        messageEditText.setText("");
      }
      textEditing=false;
      checkSendButton();
    }
  }
);
  View shareMenu=findViewById(R.id.share_menu_container);
  shareMenuCaontainer=shareMenu;
  shareMenuCaontainer.setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
    }
  }
);
  shareContainer=findViewById(R.id.closeMenuLayout);
  shareContainer.setOnTouchListener(new View.OnTouchListener(){
    @Override public boolean onTouch(    View v,    MotionEvent event){
      hideShare();
      return false;
    }
  }
);
  View.OnClickListener shareMenuOCL=new View.OnClickListener(){
    @Override public void onClick(    View item){
      if (item.getId() == R.id.share_gallery) {
        Intent intent=new Intent(Intent.ACTION_PICK,MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
        intent.setType("image/* video/*");
        startActivityForResult(intent,REQUEST_GALLERY);
      }
 else       if (item.getId() == R.id.share_camera) {
        File externalFile=Environment.getExternalStorageDirectory();
        if (externalFile == null) {
          Toast.makeText(ChatActivity.this,R.string.toast_no_sdcard,Toast.LENGTH_LONG).show();
        }
 else {
          String externalPath=externalFile.getAbsolutePath();
          String exportPathBase=externalPath + "/" + ActorSDK.sharedActor().getAppName()+ "/"+ ActorSDK.sharedActor().getAppName()+ " images"+ "/";
          new File(exportPathBase).mkdirs();
          pending_fileName=exportPathBase + "capture_" + Randoms.randomId()+ ".jpg";
        }
        if (ContextCompat.checkSelfPermission(ChatActivity.this,Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) {
          Log.d("Permissions","camera - no permission :c");
          ActivityCompat.requestPermissions(ChatActivity.this,new String[]{Manifest.permission.CAMERA},PERMISSIONS_REQUEST_CAMERA);
        }
 else {
          startCamera();
        }
      }
 else       if (item.getId() == R.id.share_video) {
        File externalFile=Environment.getExternalStorageDirectory();
        if (externalFile == null) {
          Toast.makeText(ChatActivity.this,R.string.toast_no_sdcard,Toast.LENGTH_LONG).show();
        }
 else {
          String externalPath=externalFile.getAbsolutePath();
          String exportPathBase=externalPath + "/" + ActorSDK.sharedActor().getAppName()+ "/"+ ActorSDK.sharedActor().getAppName()+ " video"+ "/";
          new File(exportPathBase).mkdirs();
          pending_fileName=exportPathBase + "capture_" + Randoms.randomId()+ ".mp4";
          Intent i=new Intent(MediaStore.ACTION_VIDEO_CAPTURE).putExtra(MediaStore.EXTRA_OUTPUT,Uri.fromFile(new File(pending_fileName)));
          startActivityForResult(i,REQUEST_VIDEO);
        }
      }
 else       if (item.getId() == R.id.share_file) {
        startActivityForResult(Intents.pickFile(ChatActivity.this),REQUEST_DOC);
      }
 else       if (item.getId() == R.id.share_location) {
        startActivityForResult(Intents.pickLocation(ChatActivity.this),REQUEST_LOCATION);
      }
 else       if (item.getId() == R.id.share_contact) {
        Intent intent=new Intent(Intent.ACTION_PICK,ContactsContract.Contacts.CONTENT_URI);
        startActivityForResult(intent,REQUEST_CONTACT);
      }
 else       if (item.getId() == R.id.share_hide) {
      }
      hideShare();
    }
  }
;
  defaultSendOcl=shareMenuOCL;
  ArrayList<ShareMenuField> menuFields=new ArrayList<>();
  menuFields.add(new ShareMenuField(getString(R.string.share_menu_camera),R.id.share_camera,R.drawable.share_camera_selector,shareMenuOCL));
  menuFields.add(new ShareMenuField(getString(R.string.share_menu_file),R.id.share_file,R.drawable.share_file_selector,shareMenuOCL));
  menuFields.add(new ShareMenuField(getString(R.string.share_menu_gallery),R.id.share_gallery,R.drawable.share_gallery_selector,shareMenuOCL));
  try {
    Class.forName("com.google.android.gms.maps.GoogleMap");
    menuFields.add(new ShareMenuField(getString(R.string.share_menu_location),R.id.share_location,R.drawable.share_location_selector,shareMenuOCL));
  }
 catch (  ClassNotFoundException e) {
  }
  menuFields.add(new ShareMenuField(getString(R.string.share_menu_video),R.id.share_video,R.drawable.share_video_selector,shareMenuOCL));
  menuFields.add(new ShareMenuField(getString(R.string.share_menu_contact),R.id.share_contact,R.drawable.share_contact_selector,shareMenuOCL));
  ActorSDK.sharedActor().getDelegate().addCustomShareMenuFields(menuFields);
  if (menuFields.size() % 2 != 0) {
    menuFields.add(new ShareMenuField(R.drawable.attach_hide2,ActorSDK.sharedActor().style.getBackyardBackgroundColor(),"",new View.OnClickListener(){
      @Override public void onClick(      View v){
      }
    }
));
  }
  FrameLayout row=(FrameLayout)findViewById(R.id.share_row_one);
  shareMenu.setBackgroundDrawable(new InsetDrawable(new ColorDrawable(ActorSDK.sharedActor().style.getMainBackgroundColor()),0,Screen.dp(2),0,0));
  shareMenu.setPadding(0,0,0,0);
  boolean first=true;
  int menuItemSize=Screen.dp(80);
  int screenWidth=getResources().getConfiguration().orientation == Configuration.ORIENTATION_PORTRAIT ? Screen.getWidth() : Screen.getHeight();
  int distance=screenWidth / (menuFields.size() / 2 + menuFields.size() % 2);
  int initialMargin=distance / 2 - menuItemSize / 2;
  int marginFromStart=initialMargin;
  int secondRowTopMargin=Screen.dp(80);
  int shareIconSize=Screen.dp(60);
  for (int i=0; i < menuFields.size(); i++) {
    ShareMenuField f=menuFields.get(i);
    LinearLayout shareItem=new LinearLayout(this);
    shareItem.setOrientation(LinearLayout.VERTICAL);
    shareItem.setGravity(Gravity.CENTER_HORIZONTAL);
    TextView title=new TextView(this);
    title.setGravity(Gravity.CENTER);
    title.setTextColor(ActorSDK.sharedActor().style.getTextPrimaryColor());
    title.setText(f.getTitle());
    ImageView icon=new ImageView(this);
    icon.setClickable(true);
    if (f.getSelector() != 0) {
      icon.setBackgroundResource(f.getSelector());
    }
 else {
      icon.setBackgroundDrawable(ShareMenuButtonFactory.get(f.getColor(),this));
      icon.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
      icon.setImageResource(f.getIcon());
    }
    shareItem.addView(icon,shareIconSize,shareIconSize);
    shareItem.addView(title);
    View.OnClickListener l=new View.OnClickListener(){
      @Override public void onClick(      View v){
        hideShare();
        f.getOnClickListener().onClick(icon);
      }
    }
;
    icon.setId(f.getId());
    icon.setOnClickListener(l);
    FrameLayout.LayoutParams params=new FrameLayout.LayoutParams(menuItemSize,menuItemSize);
    params.setMargins(marginFromStart,first ? 0 : secondRowTopMargin,initialMargin,0);
    if (i == menuFields.size() - 1) {
      menuIconToChange=icon;
      menuTitleToChange=title;
      defaultSendOcl=l;
      params.setMargins(marginFromStart,first ? 0 : secondRowTopMargin,0,0);
    }
    row.addView(shareItem,params);
    if (!first) {
      marginFromStart+=distance;
    }
    first=!first;
  }
  menuIconToChange.setTag(R.id.icon,((ImageView)menuIconToChange).getDrawable());
  menuIconToChange.setTag(R.id.background,menuIconToChange.getBackground());
  menuTitleToChange.setTag(menuTitleToChange.getText().toString());
  handleIntent();
  try {
    Class.forName("com.google.android.gms.maps.GoogleMap");
  }
 catch (  ClassNotFoundException e) {
  }
  shareSendOcl=new View.OnClickListener(){
    @Override public void onClick(    View v){
      Set<String> strings=fastShareAdapter.getSelectedVM().get();
      for (      String s : strings.toArray(new String[strings.size()])) {
        execute(messenger().sendUri(peer,Uri.fromFile(new File(s))));
      }
      fastShareAdapter.clearSelected();
      hideShare();
    }
  }
;
  RecyclerView fastShare=(RecyclerView)findViewById(R.id.fast_share);
  if (ActorSDK.sharedActor().isFastShareEnabled()) {
    fastShareAdapter=new FastShareAdapter(this);
    LinearLayoutManager layoutManager=new LinearLayoutManager(this,LinearLayoutManager.HORIZONTAL,false);
    fastShare.setAdapter(fastShareAdapter);
    fastShare.setLayoutManager(layoutManager);
    StateListDrawable background=ShareMenuButtonFactory.get(ActorSDK.sharedActor().style.getMainColor(),ChatActivity.this);
    fastShareAdapter.getSelectedVM().subscribe(new ValueChangedListener<Set<String>>(){
      @Override public void onChanged(      Set<String> val,      Value<Set<String>> valueModel){
        if (val.size() > 0) {
          menuIconToChange.setBackgroundDrawable(background);
          menuIconToChange.setImageResource(R.drawable.conv_send);
          menuIconToChange.setColorFilter(0xffffffff,PorterDuff.Mode.SRC_IN);
          menuTitleToChange.setText(getString(R.string.chat_doc_send) + "(" + val.size()+ ")");
          menuIconToChange.setOnClickListener(shareSendOcl);
          menuIconToChange.setPadding(Screen.dp(10),0,Screen.dp(5),0);
        }
 else {
          menuIconToChange.setBackgroundDrawable((Drawable)menuIconToChange.getTag(R.id.background));
          menuIconToChange.setImageDrawable((Drawable)menuIconToChange.getTag(R.id.icon));
          menuIconToChange.setColorFilter(null);
          menuIconToChange.setOnClickListener(defaultSendOcl);
          menuTitleToChange.setText((String)menuTitleToChange.getTag());
          menuIconToChange.setPadding(0,0,0,0);
        }
      }
    }
);
  }
 else {
    fastShare.setVisibility(View.GONE);
  }
  emptyBotSend=findViewById(R.id.botEmptyTextBlock);
  emptyBotHint=(TextView)findViewById(R.id.botEmptyHint);
  checkEmptyBot();
}
