{
  if (message instanceof SendMessage) {
    SendMessage sendMessage=(SendMessage)message;
    ProtoMessage holder=new ProtoMessage(sendMessage.mid,sendMessage.message);
    unsentPackages.put(holder.getMessageId(),holder);
    doSend(holder);
  }
 else   if (message instanceof ConnectionCreated) {
    ArrayList<ProtoMessage> toSend=new ArrayList<ProtoMessage>();
    for (    ProtoMessage unsentPackage : unsentPackages.values()) {
      toSend.add(unsentPackage);
    }
    doSend(toSend);
  }
 else   if (message instanceof ForgetMessage) {
    unsentPackages.remove(((ForgetMessage)message).mid);
  }
 else   if (message instanceof ConfirmMessage) {
    confirm.add(((ConfirmMessage)message).mid);
    if (confirm.size() >= ACK_THRESHOLD) {
      self().sendOnce(new ForceAck());
    }
 else     if (confirm.size() == 1) {
      self().sendOnce(new ForceAck(),ACK_DELAY);
    }
  }
 else   if (message instanceof ForceAck) {
    if (confirm.size() == 0) {
      return;
    }
    MessageAck messageAck=buildAck();
    confirm.clear();
    doSend(new ProtoMessage(MTUids.nextId(),messageAck.toByteArray()));
  }
 else   if (message instanceof NewSession) {
    ArrayList<ProtoMessage> toSend=new ArrayList<ProtoMessage>();
    for (    ProtoMessage unsentPackage : unsentPackages.values()) {
      toSend.add(unsentPackage);
    }
    doSend(toSend);
  }
}
