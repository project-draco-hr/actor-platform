{
  if (!isValidated) {
    return;
  }
  isValidated=false;
  if (seq < 0) {
    Log.d(TAG,"Loading fresh state...");
    request(new RequestGetState(new ArrayList<ApiUpdateOptimization>()),new RpcCallback<ResponseSeq>(){
      @Override public void onResult(      ResponseSeq response){
        if (isValidated) {
          return;
        }
        seq=response.getSeq();
        finishedSeq=seq;
        state=response.getState();
        isValidated=true;
        preferences().putInt(KEY_SEQ,seq);
        preferences().putBytes(KEY_STATE,state);
        Log.d(TAG,"State loaded {seq=" + seq + "}");
        checkRunnables();
        checkFuture();
        isTimerStarted=false;
        self().sendOnce(new ForceInvalidate(),24 * 60 * 60* 1000L);
      }
      @Override public void onError(      RpcException e){
        if (isValidated) {
          return;
        }
        isValidated=true;
        invalidate();
      }
    }
);
  }
 else {
    Log.d(TAG,"Loading difference...");
    onUpdateStarted();
    final long loadStart=im.actor.runtime.Runtime.getCurrentTime();
    request(new RequestGetDifference(seq,state,new ArrayList<ApiUpdateOptimization>()),new RpcCallback<ResponseGetDifference>(){
      @Override public void onResult(      final ResponseGetDifference response){
        if (isValidated) {
          return;
        }
        Log.d(TAG,"Difference loaded {seq=" + response.getSeq() + "} in "+ (im.actor.runtime.Runtime.getCurrentTime() - loadStart)+ " ms");
        seq=response.getSeq();
        state=response.getState();
        handler.onDifferenceUpdate(response).then(new Consumer<SequenceHandlerActor.UpdateProcessed>(){
          @Override public void apply(          SequenceHandlerActor.UpdateProcessed updateProcessed){
            onUpdatesApplied(response.getSeq(),response.getState());
          }
        }
).failure(new Consumer<Exception>(){
          @Override public void apply(          Exception e){
          }
        }
).done(self());
        isValidated=true;
        checkFuture();
        isTimerStarted=false;
        self().sendOnce(new ForceInvalidate(),24 * 60 * 60* 1000L);
        if (response.needMore()) {
          invalidate();
        }
 else {
          onUpdateEnded();
        }
      }
      @Override public void onError(      RpcException e){
        if (isValidated) {
          return;
        }
        isValidated=true;
        invalidate();
      }
    }
);
  }
}
