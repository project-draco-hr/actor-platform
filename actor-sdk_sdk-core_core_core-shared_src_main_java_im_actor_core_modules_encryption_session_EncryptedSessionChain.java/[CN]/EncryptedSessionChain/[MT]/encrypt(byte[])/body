{
  int messageIndex=sentCounter++;
  ActorBoxKey ratchetMessageKey=RatchetMessageKey.buildKey(rootChainKey,messageIndex);
  byte[] header=ByteStrings.merge(ByteStrings.intToBytes(session.getPeerKeyGroupId()),ByteStrings.longToBytes(session.getOwnPreKey().getKeyId()),ByteStrings.longToBytes(session.getTheirPreKey().getKeyId()),Curve25519.keyGenPublic(ownPrivateKey),theirPublicKey,ByteStrings.intToBytes(messageIndex));
  Log.d("EncryptedSessionChain#" + session.getPeerKeyGroupId(),"Own ephemeral Key: " + Crypto.keyHash(Curve25519.keyGenPublic(ownPrivateKey)));
  Log.d("EncryptedSessionChain#" + session.getPeerKeyGroupId(),"Their ephemeral Key: " + Crypto.keyHash(theirPublicKey));
  return ByteStrings.merge(header,ActorBox.closeBox(header,data,Crypto.randomBytes(32),ratchetMessageKey));
}
