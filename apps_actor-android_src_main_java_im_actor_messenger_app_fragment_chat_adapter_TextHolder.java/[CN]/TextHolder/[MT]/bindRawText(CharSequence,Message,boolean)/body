{
  if (message.getSenderId() == myUid()) {
    messageBubble.setBackgroundResource(R.drawable.bubble_text_out);
  }
 else {
    messageBubble.setBackgroundResource(R.drawable.bubble_text_in);
  }
  if (isItalic) {
    text.setTypeface(Fonts.italic());
  }
 else {
    text.setTypeface(Fonts.regular());
  }
  text.setText(spannedText);
  text.setMovementMethod(new CustomLinkMovementMethod());
  if (!isMarkdownEnabled && !isMdExt) {
    Linkify.addLinks(text,Linkify.EMAIL_ADDRESSES | Linkify.PHONE_NUMBERS | Linkify.WEB_URLS);
  }
  String regex="(people:\\/\\/)([0-9]{1,20})";
  Pattern p=Pattern.compile(regex);
  Matcher m=p.matcher(text.getText().toString());
  SpannableString s=SpannableString.valueOf(text.getText());
  while (m.find()) {
    MentionSpan span=new MentionSpan(m.group(),false);
    s.setSpan(span,m.start(),m.end(),Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
  }
  text.setText(s);
  regex="(https:\\/\\/)(quit\\.email\\/join\\/)([0-9-a-z]{1,64})";
  p=Pattern.compile(regex);
  m=p.matcher(text.getText().toString());
  s=SpannableString.valueOf(text.getText());
  while (m.find()) {
    URLSpan span=new URLSpan(m.group());
    s.setSpan(span,m.start(),m.end(),Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
  }
  text.setText(s);
  QuoteSpan[] qSpans=s.getSpans(0,s.length(),QuoteSpan.class);
  text.setMinimumWidth(0);
  if (qSpans.length > 0) {
    text.measure(0,0);
    text.setMinimumWidth(text.getMeasuredWidth() + qSpans[0].getLeadingMargin(true));
  }
  if (message.getSenderId() == myUid()) {
    status.setVisibility(View.VISIBLE);
switch (message.getMessageState()) {
case SENT:
      status.setResource(R.drawable.msg_check_1);
    status.setTint(sentColor);
  break;
case RECEIVED:
status.setResource(R.drawable.msg_check_2);
status.setTint(deliveredColor);
break;
case READ:
status.setResource(R.drawable.msg_check_2);
status.setTint(readColor);
break;
default :
case PENDING:
status.setResource(R.drawable.msg_clock);
status.setTint(waitColor);
break;
case ERROR:
status.setResource(R.drawable.msg_error);
status.setTint(errorColor);
break;
}
}
 else {
status.setVisibility(View.GONE);
}
time.setText(TextUtils.formatTime(message.getDate()));
}
