{
  ArrayList<StickersPack> add=new ArrayList<StickersPack>();
  ArrayList<Sticker> addStickers=new ArrayList<Sticker>();
  ArrayList<Sticker> removeStickers=new ArrayList<Sticker>();
  for (  ApiStickerCollection collection : updated) {
    add.add(StickersPack.createLocalStickerPack(collection,getLocalCollectionId(collection.getId())));
    if (collection.getStickers().size() > 0) {
      stickers.addOrUpdateItem(new Sticker(collection.getStickers().get(0),collection.getId(),getLocalCollectionId(collection.getId()),collection.getAccessHash(),true));
    }
    StickersPack oldPack=packs.getValue(collection.getId());
    if (oldPack != null) {
      for (      Sticker oldSt : oldPack.getStickers()) {
        removeStickers.add(stickers.getValue(oldSt.getId()));
      }
    }
    for (    ApiStickerDescriptor s : collection.getStickers()) {
      removeStickers.remove(stickers.getValue(s.getId()));
      if (stickers.getValue(s.getId()) == null) {
        addStickers.add(new Sticker(s,collection.getId(),getLocalCollectionId(collection.getId()),collection.getAccessHash()));
      }
    }
  }
  long[] removeStickersIds=new long[removeStickers.size()];
  for (int i=0; i < removeStickers.size(); i++) {
    removeStickersIds[i]=removeStickers.get(i).getId();
  }
  stickers.removeItems(removeStickersIds);
  packs.addOrUpdateItems(add);
  stickers.addOrUpdateItems(addStickers);
}
