{
  boolean isPeerEnabled=modules().getSettings().isNotificationsEnabled(peer);
  boolean isEnabled=(modules().getSettings().isNotificationsEnabled() && isPeerEnabled) || hasCurrentUserMention;
  boolean isInAppEnabled=modules().getSettings().isInAppEnabled();
  boolean isConversationTonesEnabled=modules().getSettings().isConversationTonesEnabled();
  if (!isEnabled && (!(isInAppEnabled && peer.equals(visiblePeer)))) {
    return;
  }
  List<PendingNotification> allPending=getNotifications();
  allPending.add(new PendingNotification(peer,sender,date,description));
  saveStorage();
  if (isNotificationsPaused) {
    notificationsDuringPause.add(peer);
    return;
  }
  if (config().getNotificationProvider() != null) {
    if (isAppVisible) {
      if (visiblePeer != null && visiblePeer.equals(peer)) {
        if (isConversationTonesEnabled) {
          config().getNotificationProvider().onMessageArriveInApp(modules().getMessenger());
        }
      }
 else       if (isDialogsVisible) {
        if (isConversationTonesEnabled) {
          config().getNotificationProvider().onMessageArriveInApp(modules().getMessenger());
        }
      }
 else       if (isInAppEnabled) {
        performNotification(false);
      }
    }
 else {
      performNotification(false);
    }
  }
}
