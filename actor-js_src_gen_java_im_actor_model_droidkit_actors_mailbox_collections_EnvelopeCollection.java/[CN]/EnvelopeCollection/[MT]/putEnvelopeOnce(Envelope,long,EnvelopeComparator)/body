{
  long key=root.buildKey(time);
  long oldKey;
synchronized (envelopes) {
    oldKey=topKey;
    Iterator<Map.Entry<Long,ScheduledEnvelope>> iterator=envelopes.entrySet().iterator();
    while (iterator.hasNext()) {
      if (comparator.equals(iterator.next().getValue().getEnvelope(),envelope)) {
        iterator.remove();
      }
    }
    envelopes.put(key,new ScheduledEnvelope(key,time,envelope));
    topKey=envelopes.firstKey();
  }
  if (oldKey != topKey) {
    root.changedTopKey(this);
  }
  return key;
}
