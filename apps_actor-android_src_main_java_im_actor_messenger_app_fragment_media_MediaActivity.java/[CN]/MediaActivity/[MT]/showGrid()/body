{
  getWindow().setBackgroundDrawable(new ColorDrawable(Color.BLACK));
  emptyView.setAlpha(1);
  recyclerView.setAlpha(1);
  goneView(emptyView,false);
  showView(recyclerView,false);
  chatType=activityIntent.getIntExtra(ARG_CHAT_TYPE,0);
  chatId=activityIntent.getIntExtra(ARG_CHAT_ID,0);
  peer=Peer.fromUniqueId(activityIntent.getLongExtra(EXTRA_PEER_UNIQ_ID,0));
  setGridActionbar();
  emptyView.setVisibility(View.GONE);
  displayList=messenger().getMediaGlobalList(peer);
  adapter=new MediaAdapter(displayList,new OnMediaClickListener(){
    @Override public void onClick(    final MediaAdapter.MediaHolder holder,    Message item){
      final TransitionAnimation animation=new TransitionAnimation(){
        @Override public Runnable runnable(        final View view,        final Bitmap bitmap){
          return new Runnable(){
            @Override public void run(){
              int[] location=new int[2];
              transitionImageView.setExtraReceiverCallback(null);
              if (!skipAnimation) {
                view.getLocationInWindow(location);
                MediaFullscreenAnimationUtils.animateForward(transitionImageView,bitmap,location[0],location[1],view.getWidth(),view.getHeight(),new AnimatorListenerAdapter(){
                  @Override public void onAnimationEnd(                  Animator animation){
                    showPager();
                  }
                }
);
                transitionBackgroundView.postDelayed(new Runnable(){
                  @Override public void run(){
                    MediaFullscreenAnimationUtils.animateBackgroundForward(transitionBackgroundView,null);
                  }
                }
,50);
              }
 else {
                showPager();
              }
            }
          }
;
        }
      }
;
      viewPager.setAdapter(pagerAdapter);
      viewPager.setVisibility(View.VISIBLE);
      viewPager.setAlpha(0);
      transitionBackgroundView.setVisibility(View.VISIBLE);
      transitionBackgroundView.setAlpha(0);
      final View view=holder.itemView;
      transitionImageView.setExtraReceiverCallback(new ReceiverCallback(){
        @Override public void onImageLoaded(        BitmapReference bitmapRef){
          Bitmap bitmap=bitmapRef.getBitmap();
          selectedIndex=holder.getPosition();
          holder.itemView.post(animation.runnable(holder.itemView,bitmap));
        }
        @Override public void onImageCleared(){
        }
        @Override public void onImageError(){
        }
      }
);
      final DocumentContent document=(DocumentContent)item.getContent();
      if (document.getSource() instanceof FileRemoteSource) {
        FileRemoteSource remoteSource=(FileRemoteSource)document.getSource();
        final FileReference location=remoteSource.getFileReference();
        messenger().requestState(location.getFileId(),new FileCallback(){
          @Override public void onNotDownloaded(){
            selectedIndex=holder.getPosition();
            animation.skipAnimation();
            animation.runnable(null,null).run();
          }
          @Override public void onDownloading(          float progress){
          }
          @Override public void onDownloaded(          final FileSystemReference reference){
            MVVMEngine.runOnUiThread(new Runnable(){
              @Override public void run(){
                transitionImageView.post(new Runnable(){
                  @Override public void run(){
                    transitionImageView.request(new RawFileTask(reference.getDescriptor()));
                  }
                }
);
              }
            }
);
          }
        }
);
        Logger.d(TAG,"Remote =(");
      }
 else       if (document.getSource() instanceof FileLocalSource) {
        final String path=((FileLocalSource)document.getSource()).getFileDescriptor();
      }
    }
  }
,this);
  pagerAdapter=new MediaPagerAdapter(displayList,this);
  toolbar.post(new Runnable(){
    @Override public void run(){
      int toolbarHeight=toolbar.getHeight();
      recyclerView.setPadding(0,toolbarHeight,0,Screen.getNavbarHeight());
    }
  }
);
  recyclerView.setLayoutManager(new GridLayoutManager(this,getResources().getInteger(R.integer.gallery_items_count)));
  recyclerView.setAdapter(adapter);
}
