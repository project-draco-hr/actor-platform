{
  byte[] rSeed=ByteStrings.merge(label.getBytes(),seed);
  byte[] res=new byte[length];
  byte[] A=rSeed;
  byte[] tHash=new byte[hash.getHashSize()];
  int offset=0;
  while (offset * 32 < length) {
    HMAC.hmac(secret,A,0,A.length,tHash,0,hash);
    A=new byte[hash.getHashSize()];
    ByteStrings.write(A,0,tHash,0,A.length);
    hash.hash(ByteStrings.merge(secret,A,rSeed),0,secret.length + A.length + rSeed.length,tHash,0);
    ByteStrings.write(res,offset * hash.getHashSize(),tHash,0,Math.min(tHash.length,res.length - offset * hash.getHashSize()));
    offset++;
  }
  return res;
}
