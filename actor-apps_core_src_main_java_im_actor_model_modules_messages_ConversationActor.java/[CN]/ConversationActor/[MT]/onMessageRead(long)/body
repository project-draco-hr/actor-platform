{
  if (date <= outReadState) {
    return;
  }
  outReadState=date;
  preferences().putLong(OUT_READ_STATE_PREF,date);
  ArrayList<MessageRef> res=outMessagesStorage.removeBeforeDate(date);
  if (res.size() > 0) {
    long minRid=-1;
    long minDate=Long.MAX_VALUE;
    ArrayList<Message> updated=new ArrayList<Message>();
    for (    MessageRef ref : res) {
      Message msg=messages.getValue(ref.getRid());
      if (msg != null && msg.isReceivedOrSent()) {
        if (ref.getDate() < minDate) {
          minDate=ref.getDate();
          minRid=ref.getRid();
        }
        updated.add(msg.changeState(MessageState.READ));
      }
    }
    if (updated.size() > 0) {
      messages.addOrUpdateItems(updated);
    }
    if (minRid != -1) {
      dialogsActor.send(new DialogsActor.MessageStateChanged(peer,minRid,MessageState.READ));
    }
    saveOutPending();
  }
}
