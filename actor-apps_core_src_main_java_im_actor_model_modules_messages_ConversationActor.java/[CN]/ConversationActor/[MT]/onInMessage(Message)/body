{
  if (messages.getValue(message.getEngineId()) != null) {
    return;
  }
  if (message.getSenderId() == myUid()) {
    if (message.isOnServer()) {
      if (message.getSortDate() <= outReadState) {
        message=message.changeState(MessageState.READ);
      }
 else       if (message.getSortDate() <= outReceiveState) {
        message=message.changeState(MessageState.RECEIVED);
      }
 else {
        message=message.changeState(MessageState.SENT);
      }
    }
  }
  messages.addOrUpdateItem(message);
  if (message.isOnServer()) {
    if (message.getSenderId() == myUid()) {
      if (message.isOnServer() && message.getMessageState() != MessageState.READ) {
        outMessagesStorage.addOrUpdate(message.getRid(),message.getDate());
        saveOutPending();
      }
    }
 else {
      if (message.getSortDate() <= inReadState) {
        return;
      }
      inMessagesStorage.addOrUpdate(message.getRid(),message.getDate());
      dialogsActor.send(new DialogsActor.InMessage(peer,message,inMessagesStorage.getCount()));
      saveInPending();
    }
  }
}
