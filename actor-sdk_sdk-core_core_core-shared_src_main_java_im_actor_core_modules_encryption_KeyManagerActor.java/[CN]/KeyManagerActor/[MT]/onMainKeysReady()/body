{
  Log.d(TAG,"Main Keys are ready");
  int missingKeysCount=Math.max(0,Configuration.EPHEMERAL_KEYS_COUNT - ownKeys.getPreKeys().length);
  if (missingKeysCount > 0) {
    PrivateKey[] nKeys=new PrivateKey[missingKeysCount];
    for (int i=0; i < missingKeysCount; i++) {
      nKeys[i]=new PrivateKey(RandomUtils.nextRid(),"curve25519",Curve25519.keyGenPrivate(Crypto.randomBytes(64)),false);
    }
    ownKeys=ownKeys.appendPreKeys(nKeys);
    encryptionKeysStorage.addOrUpdateItem(0,ownKeys.toByteArray());
  }
  final ArrayList<PrivateKey> pendingEphermalKeys=new ArrayList<PrivateKey>();
  for (  PrivateKey key : ownKeys.getPreKeys()) {
    if (!key.isUploaded()) {
      pendingEphermalKeys.add(key);
    }
  }
  if (pendingEphermalKeys.size() > 0) {
    final ArrayList<ApiEncryptionKey> uploadingKeys=new ArrayList<ApiEncryptionKey>();
    ArrayList<ApiEncryptionKeySignature> uploadingSignatures=new ArrayList<ApiEncryptionKeySignature>();
    for (    PrivateKey k : pendingEphermalKeys) {
      ApiEncryptionKey apiKey=new ApiEncryptionKey(k.getKeyId(),k.getKeyAlg(),Curve25519.keyGenPublic(k.getKey()),null);
      uploadingKeys.add(apiKey);
      byte[] signature=Curve25519.calculateSignature(Crypto.randomBytes(64),ownKeys.getIdentityKey().getKey(),apiKey.toByteArray());
      uploadingSignatures.add(new ApiEncryptionKeySignature(k.getKeyId(),"Ed25519",signature));
    }
    api(new RequestUploadEphermalKey(ownKeys.getKeyGroupId(),uploadingKeys,uploadingSignatures)).then(new Consumer<ResponseVoid>(){
      @Override public void apply(      ResponseVoid responseVoid){
        ownKeys=ownKeys.markAsUploaded(pendingEphermalKeys.toArray(new PrivateKey[pendingEphermalKeys.size()]));
        encryptionKeysStorage.addOrUpdateItem(0,ownKeys.toByteArray());
        onAllKeysReady();
      }
    }
).failure(new Consumer<Exception>(){
      @Override public void apply(      Exception e){
        Log.w(TAG,"Ephemeral keys upload error");
        Log.e(TAG,e);
      }
    }
).done(self());
  }
 else {
    onAllKeysReady();
  }
}
