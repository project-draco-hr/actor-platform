{
  Log.d(TAG,"Main Keys are ready");
  for (  KeyValueRecord r : ephemeralStorage.loadAllItems()) {
    try {
      EphemeralEncryptionKey encryptionKey=new EphemeralEncryptionKey(r.getData());
      ephemeralKeys.put(encryptionKey.getEncryptionKey().getKeyId(),encryptionKey);
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
  }
  for (int i=0; i < 100 - ephemeralKeys.size(); i++) {
    long randomId=RandomUtils.nextRid();
    EncryptionKey encryptionKey=new EncryptionKey(randomId,Curve25519.keyGen(Crypto.randomBytes(64)));
    EphemeralEncryptionKey ephemeralEncryptionKey=new EphemeralEncryptionKey(encryptionKey,false);
    ephemeralStorage.addOrUpdateItem(randomId,ephemeralEncryptionKey.toByteArray());
    ephemeralKeys.put(randomId,ephemeralEncryptionKey);
  }
  final ArrayList<EphemeralEncryptionKey> pendingEphermalKeys=new ArrayList<EphemeralEncryptionKey>();
  for (  EphemeralEncryptionKey record : ephemeralKeys.values()) {
    if (!record.isUploaded()) {
      pendingEphermalKeys.add(record);
    }
  }
  if (pendingEphermalKeys.size() > 0) {
    ArrayList<ApiEncryptionKey> uploadingKeys=new ArrayList<ApiEncryptionKey>();
    ArrayList<ApiEncryptionKeySignature> uploadingSignatures=new ArrayList<ApiEncryptionKeySignature>();
    for (    EphemeralEncryptionKey k : pendingEphermalKeys) {
      ApiEncryptionKey apiKey=new ApiEncryptionKey(k.getEncryptionKey().getKeyId(),k.getEncryptionKey().getKeyAlg(),k.getEncryptionKey().getPublicKey(),null);
      uploadingKeys.add(apiKey);
      byte[] signature=Curve25519.calculateSignature(Crypto.randomBytes(64),privateKeyStorage.getIdentityKey().getPrivateKey(),apiKey.toByteArray());
      uploadingSignatures.add(new ApiEncryptionKeySignature(k.getEncryptionKey().getKeyId(),"Ed25519",signature));
    }
    request(new RequestUploadEphermalKey(privateKeyStorage.getKeyGroupId(),uploadingKeys,uploadingSignatures),new RpcCallback<ResponseVoid>(){
      @Override public void onResult(      ResponseVoid response){
        List<KeyValueRecord> updated=new ArrayList<KeyValueRecord>();
        for (        EphemeralEncryptionKey k : pendingEphermalKeys) {
          EphemeralEncryptionKey uploaded=k.markUploaded();
          updated.add(new KeyValueRecord(uploaded.getEncryptionKey().getKeyId(),uploaded.toByteArray()));
          ephemeralKeys.put(uploaded.getEncryptionKey().getKeyId(),uploaded);
        }
        ephemeralStorage.addOrUpdateItems(updated);
        onAllKeysReady();
      }
      @Override public void onError(      RpcException e){
        Log.w(TAG,"Ephemeral keys upload error");
        Log.e(TAG,e);
      }
    }
);
  }
 else {
    onAllKeysReady();
  }
}
