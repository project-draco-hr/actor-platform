{
  if (LOG) {
    Log.d(TAG,"Binding file #" + fileReference.getFileId());
  }
  Downloaded downloaded1=downloaded.getValue(fileReference.getFileId());
  if (downloaded1 != null) {
    FileSystemReference reference=Storage.fileFromDescriptor(downloaded1.getDescriptor());
    boolean isExist=reference.isExist();
    int fileSize=reference.getSize();
    if (isExist && fileSize == downloaded1.getFileSize()) {
      if (LOG) {
        Log.d(TAG,"- Downloaded");
      }
      final FileSystemReference fileSystemReference=Storage.fileFromDescriptor(downloaded1.getDescriptor());
      im.actor.runtime.Runtime.dispatch(new Runnable(){
        @Override public void run(){
          callback.onDownloaded(fileSystemReference);
        }
      }
);
      return;
    }
 else {
      if (LOG) {
        Log.d(TAG,"- File is corrupted");
        if (!isExist) {
          Log.d(TAG,"- File not found");
        }
        if (fileSize != downloaded1.getFileSize()) {
          Log.d(TAG,"- Incorrect file size. Expected: " + downloaded1.getFileSize() + ", got: "+ fileSize);
        }
      }
      downloaded.removeItem(downloaded1.getFileId());
    }
  }
  QueueItem queueItem=findItem(fileReference.getFileId());
  if (queueItem == null) {
    if (LOG) {
      Log.d(TAG,"- Adding to queue");
    }
    queueItem=new QueueItem(fileReference);
    queueItem.callbacks.add(callback);
    if (autoStart) {
      queueItem.isStopped=false;
      im.actor.runtime.Runtime.dispatch(new Runnable(){
        @Override public void run(){
          callback.onDownloading(0);
        }
      }
);
    }
 else {
      queueItem.isStopped=true;
      im.actor.runtime.Runtime.dispatch(new Runnable(){
        @Override public void run(){
          callback.onNotDownloaded();
        }
      }
);
    }
    queue.add(0,queueItem);
  }
 else {
    Log.d(TAG,"- Promoting in queue");
    promote(fileReference.getFileId());
    if (!queueItem.callbacks.contains(callback)) {
      queueItem.callbacks.add(callback);
    }
    if (queueItem.isStopped) {
      im.actor.runtime.Runtime.dispatch(new Runnable(){
        @Override public void run(){
          callback.onNotDownloaded();
        }
      }
);
    }
 else {
      if (queueItem.isStarted) {
        final float progress=queueItem.progress;
        im.actor.runtime.Runtime.dispatch(new Runnable(){
          @Override public void run(){
            callback.onDownloading(progress);
          }
        }
);
      }
 else {
        im.actor.runtime.Runtime.dispatch(new Runnable(){
          @Override public void run(){
            callback.onDownloading(0);
          }
        }
);
      }
    }
  }
  checkQueue();
}
