{
  if (isLastInDiff) {
    self().send(new ResumeNotifications());
  }
  if (isAlreadyRead) {
    return;
  }
  boolean isPeerEnabled=modules().getSettings().isNotificationsEnabled(peer);
  boolean isEnabled=(modules().getSettings().isNotificationsEnabled() && isPeerEnabled) || hasCurrentUserMention;
  if (isEnabled) {
    List<PendingNotification> allPending=getNotifications();
    allPending.add(new PendingNotification(peer,sender,date,description));
    saveStorage();
  }
  if (isNotificationsPaused) {
    if (isEnabled) {
      notificationsDuringPause.add(peer);
    }
    return;
  }
  if (config().getNotificationProvider() != null) {
    if (isAppVisible) {
      if (visiblePeer != null && visiblePeer.equals(peer)) {
        if (modules().getSettings().isConversationTonesEnabled()) {
          config().getNotificationProvider().onMessageArriveInApp(modules().getMessenger());
        }
      }
 else       if (isDialogsVisible) {
        if (modules().getSettings().isConversationTonesEnabled()) {
          config().getNotificationProvider().onMessageArriveInApp(modules().getMessenger());
        }
      }
 else       if (modules().getSettings().isInAppEnabled()) {
        if (isPeerEnabled) {
          performNotification(false);
        }
      }
    }
 else {
      if (isEnabled) {
        performNotification(false);
      }
    }
  }
}
