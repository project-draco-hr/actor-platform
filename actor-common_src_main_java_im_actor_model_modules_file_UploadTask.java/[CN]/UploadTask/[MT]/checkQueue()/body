{
  if (isCompleted) {
    return;
  }
  if (nextBlock == blocksCount && uploadCount == 0) {
    Log.d(TAG,"Completing...");
    long crc=crc32.getValue();
    Log.d(TAG,"Src #" + crc);
    request(new RequestCompleteUpload(uploadConfig,blocksCount,crc),new RpcCallback<ResponseCompleteUpload>(){
      @Override public void onResult(      ResponseCompleteUpload response){
        Log.d(TAG,"Upload completed...");
        reportComplete(EntityConverter.convert(response.getLocation(),"",srcReference.getSize()));
      }
      @Override public void onError(      RpcException e){
        Log.d(TAG,"Upload complete error");
        reportError();
      }
    }
);
    return;
  }
  if (nextBlock < blocksCount && uploadCount < SIM_BLOCKS_COUNT) {
    final int blockIndex=nextBlock++;
    int size=blockSize;
    int fileOffset=blockIndex * blockSize;
    if ((blockIndex + 1) * blockSize > srcReference.getSize()) {
      size=srcReference.getSize() - blockIndex * blockSize;
    }
    byte[] data=new byte[size];
    if (!inputFile.read(fileOffset,data,0,size)) {
      Log.d(TAG,"read #" + blockIndex + " error");
      reportError();
      return;
    }
    crc32.update(data,0,size);
    Log.d(TAG,"Starting block upload #" + blockIndex);
    uploadCount++;
    uploadPart(blockIndex,fileOffset,data);
    checkQueue();
  }
 else {
    Log.d(TAG,"Nothing to do");
  }
}
