{
  super.onCreate(saveInstance);
  keyboardUtils=new KeyboardHelper(this);
  peer=Peer.fromUid(getIntent().getExtras().getLong(Intents.EXTRA_CHAT_PEER));
  isCompose=saveInstance == null && getIntent().getExtras().getBoolean(Intents.EXTRA_CHAT_COMPOSE,false);
  messenger=messenger();
  getSupportActionBar().setDisplayShowCustomEnabled(true);
  getSupportActionBar().setDisplayHomeAsUpEnabled(true);
  getSupportActionBar().setDisplayShowHomeEnabled(true);
  getSupportActionBar().setDisplayShowTitleEnabled(false);
  getSupportActionBar().setDisplayUseLogoEnabled(false);
  barView=LayoutInflater.from(this).inflate(R.layout.bar_conversation,null);
  barTitle=(TextView)barView.findViewById(R.id.title);
  barSubtitleContainer=barView.findViewById(R.id.subtitleContainer);
  barTypingIcon=(ImageView)barView.findViewById(R.id.typingImage);
  barTypingIcon.setImageDrawable(new TypingDrawable());
  barTyping=(TextView)barView.findViewById(R.id.typing);
  barSubtitle=(TextView)barView.findViewById(R.id.subtitle);
  barTypingContainer=barView.findViewById(R.id.typingContainer);
  barTypingContainer.setVisibility(View.INVISIBLE);
  barAvatar=(AvatarView)barView.findViewById(R.id.avatarPreview);
  ActionBar.LayoutParams layout=new ActionBar.LayoutParams(ActionBar.LayoutParams.MATCH_PARENT,ActionBar.LayoutParams.MATCH_PARENT);
  getSupportActionBar().setCustomView(barView,layout);
  barView.findViewById(R.id.titleContainer).setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      if (peer.getPeerType() == PeerType.PRIVATE) {
        startActivity(Intents.openProfile(peer.getPeerId(),ChatActivity.this));
      }
 else       if (peer.getPeerType() == PeerType.GROUP) {
      }
    }
  }
);
  setContentView(R.layout.activity_dialog);
  getWindow().setBackgroundDrawable(null);
  getFragmentManager().beginTransaction().add(R.id.messagesFragment,MessagesFragment.create(peer)).commit();
  messageBody=(EditText)findViewById(R.id.et_message);
  messageBody.addTextChangedListener(new TextWatcher(){
    @Override public void beforeTextChanged(    CharSequence s,    int start,    int count,    int after){
      if (after > count && !isTypingDisabled) {
        messenger.onTyping(peer);
      }
    }
    @Override public void onTextChanged(    CharSequence s,    int start,    int before,    int count){
    }
    @Override public void afterTextChanged(    Editable s){
      if (s.length() > 0) {
        sendButton.setTint(getResources().getColor(R.color.conv_send_enabled));
        sendButton.setEnabled(true);
      }
 else {
        sendButton.setTint(getResources().getColor(R.color.conv_send_disabled));
        sendButton.setEnabled(false);
      }
    }
  }
);
  messageBody.setOnKeyListener(new View.OnKeyListener(){
    @Override public boolean onKey(    View view,    int keycode,    KeyEvent keyEvent){
      if (ChatSettings.getInstance().isSendByEnter()) {
        if (keyEvent.getAction() == KeyEvent.ACTION_DOWN && keycode == KeyEvent.KEYCODE_ENTER) {
          sendMessage();
          return true;
        }
      }
      return false;
    }
  }
);
  messageBody.setOnEditorActionListener(new TextView.OnEditorActionListener(){
    @Override public boolean onEditorAction(    TextView textView,    int i,    KeyEvent keyEvent){
      if (i == EditorInfo.IME_ACTION_SEND) {
        sendMessage();
        return true;
      }
      if (i == EditorInfo.IME_ACTION_DONE) {
        sendMessage();
        return true;
      }
      if (ChatSettings.getInstance().isSendByEnter()) {
        if (keyEvent != null && i == EditorInfo.IME_NULL && keyEvent.getAction() == KeyEvent.ACTION_DOWN) {
          sendMessage();
          return true;
        }
      }
      return false;
    }
  }
);
  kicked=findViewById(R.id.kickedFromChat);
  kicked.setVisibility(View.GONE);
  sendButton=(TintImageView)findViewById(R.id.ib_send);
  sendButton.setResource(R.drawable.conv_send);
  sendButton.setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      sendMessage();
    }
  }
);
  attachButton=(ImageButton)findViewById(R.id.ib_attach);
  attachButton.setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      Context wrapper=new ContextThemeWrapper(ChatActivity.this,R.style.AttachPopupTheme);
      PopupMenu popup=new PopupMenu(wrapper,findViewById(R.id.attachAnchor));
      try {
        Field[] fields=popup.getClass().getDeclaredFields();
        for (        Field field : fields) {
          if ("mPopup".equals(field.getName())) {
            field.setAccessible(true);
            Object menuPopupHelper=field.get(popup);
            Class<?> classPopupHelper=Class.forName(menuPopupHelper.getClass().getName());
            Method setForceIcons=classPopupHelper.getMethod("setForceShowIcon",boolean.class);
            setForceIcons.invoke(menuPopupHelper,true);
            break;
          }
        }
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
      if (BuildConfig.ENABLE_CHROME) {
        popup.getMenuInflater().inflate(R.menu.attach_popup_chrome,popup.getMenu());
      }
 else {
        popup.getMenuInflater().inflate(R.menu.attach_popup,popup.getMenu());
      }
      popup.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener(){
        @Override public boolean onMenuItemClick(        MenuItem item){
          if (item.getItemId() == R.id.gallery) {
            Intent intent=new Intent(Intent.ACTION_PICK,MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
            intent.setType("image/* video/*");
            startActivityForResult(intent,REQUEST_GALLERY);
            return true;
          }
 else           if (item.getItemId() == R.id.takePhoto) {
            File externalFile=getExternalFilesDir(null);
            if (externalFile == null) {
              Toast.makeText(ChatActivity.this,R.string.toast_no_sdcard,Toast.LENGTH_LONG).show();
              return true;
            }
            String externalPath=externalFile.getAbsolutePath();
            new File(externalPath + "/actor/").mkdirs();
            fileName=externalPath + "/actor/capture_" + RandomUtil.randomId()+ ".jpg";
            startActivityForResult(new Intent(MediaStore.ACTION_IMAGE_CAPTURE).putExtra(MediaStore.EXTRA_OUTPUT,Uri.fromFile(new File(fileName))),REQUEST_PHOTO);
          }
 else           if (item.getItemId() == R.id.takeVideo) {
            File externalFile=getExternalFilesDir(null);
            if (externalFile == null) {
              Toast.makeText(ChatActivity.this,R.string.toast_no_sdcard,Toast.LENGTH_LONG).show();
              return true;
            }
            String externalPath=externalFile.getAbsolutePath();
            new File(externalPath + "/actor/").mkdirs();
            fileName=externalPath + "/actor/capture_" + RandomUtil.randomId()+ ".jpg";
            Intent i=new Intent(MediaStore.ACTION_VIDEO_CAPTURE).putExtra(MediaStore.EXTRA_OUTPUT,Uri.fromFile(new File(fileName)));
            startActivityForResult(i,REQUEST_VIDEO);
            return true;
          }
 else           if (item.getItemId() == R.id.file) {
            startActivityForResult(Intents.pickFile(ChatActivity.this),REQUEST_DOC);
          }
 else           if (item.getItemId() == R.id.location) {
            startActivityForResult(com.droidkit.pickers.Intents.pickLocation(ChatActivity.this),REQUEST_LOCATION);
          }
          return false;
        }
      }
);
      popup.show();
    }
  }
);
}
