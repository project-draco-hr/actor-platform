{
  decorView.getViewTreeObserver().addOnGlobalLayoutListener(new OnGlobalLayoutListener(){
    @Override public void onGlobalLayout(){
      if (!softKeyboardListeningEnabled) {
        return;
      }
      Rect r=new Rect();
      decorView.getWindowVisibleDisplayFrame(r);
      int screenHeight=decorView.getRootView().getHeight();
      int heightDifference=screenHeight - (r.bottom - r.top);
      int resourceId=activity.getResources().getIdentifier("status_bar_height","dimen","android");
      if (resourceId > 0) {
        heightDifference-=activity.getResources().getDimensionPixelSize(resourceId);
      }
      int orientation=activity.getResources().getConfiguration().orientation;
      int id=activity.getResources().getIdentifier("config_showNavigationBar","bool","android");
      if (id > 0) {
        if (activity.getResources().getBoolean(id)) {
          int navbarResId=activity.getResources().getIdentifier(orientation == Configuration.ORIENTATION_PORTRAIT ? "navigation_bar_height" : "navigation_bar_height_landscape","dimen","android");
          if (navbarResId > 0) {
            heightDifference-=activity.getResources().getDimensionPixelSize(navbarResId);
          }
        }
      }
      if (heightDifference > 100) {
        keyBoardHeight=heightDifference;
        setSize(LayoutParams.MATCH_PARENT,keyBoardHeight);
        if (isOpened == false) {
          if (onSoftKeyboardOpenCloseListener != null)           onSoftKeyboardOpenCloseListener.onKeyboardOpen(keyBoardHeight);
        }
        isOpened=true;
      }
 else {
        isOpened=false;
        if (onSoftKeyboardOpenCloseListener != null)         onSoftKeyboardOpenCloseListener.onKeyboardClose();
        if (isShowing())         dismiss();
      }
    }
  }
);
}
